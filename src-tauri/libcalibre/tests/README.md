# Testing `libcalibre`

This contains tests for libcalibre, including snapshot-based tests. We aim to
exactly match Calibre's behaviour.

## Philosophy

- Most tests should be focused unit tests that validate against examples
- Some tests can be full database snapshot tests to identify any differences
  between libcalibre and Calibre
  	- We focus on main effects and side effects
    - When generating tests (for validating implementations), snapshots may
    	highlight unexpected behaviour from Calibre, like unknown tables.

## Structure

```
tests/
├── README.md                    # This file
├── common/                      # Shared test utilities
│   ├── mod.rs
│   ├── snapshot.rs             # DatabaseSnapshot implementation
│   └── helpers.rs              # Test helpers and fixtures
├── fixtures/                    # Pre-generated Calibre databases
│   └── empty_library/          # Fresh Calibre 7.2 library
│       ├── metadata.db
│       └── .calnotes/
├── snapshots/                   # Committed snapshot files (YAML)
│   └── *.snap                  # Generated by insta
└── *_test.rs                    # Individual test files
```

## How Snapshot Testing Works

### 1. Capture Full Database State

The `DatabaseSnapshot` module captures:
- **Schema**: All tables and their column definitions
- **Data**: All rows from all tables (as key-value maps)

This means we see **everything** Calibre does, not just the tables/columns we
explicitly use.

### 2. Normalize Non-Deterministic Values

Before comparing, we normalize:
- **UUIDs**: `550e8400-...` → `<UUID>`
- **Timestamps**: `2024-01-31 18:10:00` → `<TIMESTAMP>`
- **Row ordering**: Sorted by ID for deterministic output

### 3. Compare to Committed Snapshot

Tests compare the current database state to a committed YAML snapshot. If they
differ, the test fails and shows you the diff.

## Running Tests

```bash
# Run all tests
cargo test

# Run specific test
cargo test test_add_single_book

# Review snapshot changes
cargo insta review
```

### First Run (Creating Snapshots)

When you run a test for the first time, it will fail because the snapshot
doesn't exist yet:

```bash
$ cargo test test_add_single_book
# Test fails: "snapshot does not exist"

$ cargo insta review
# Shows you the captured snapshot
# Press 'a' to accept it
# Press 'r' to reject it
```

Once accepted, the snapshot is saved to `snapshots/` and committed to git.

### Subsequent Runs (Comparing to Snapshots)

```bash
$ cargo test
# Passes if database state matches snapshot
# Fails if there are differences
```

If a test fails:

```bash
$ cargo insta review
# Shows the diff between expected and actual
# Accept ('a') if the change is intentional
# Reject ('r') if it's a bug
```

## Creating Fixtures with Calibre

Fixtures are **pre-generated Calibre databases** used as test starting points.

### One-Time Setup (Requires Calibre CLI)

```bash
# 1. Create a fresh Calibre library
calibredb add_empty_library ./test_library

# 2. (Optional) Perform operations
calibredb add book.epub --library-path=./test_library

# 3. Copy to fixtures directory
cp -r ./test_library/* tests/fixtures/my_fixture/

# 4. Commit to git
git add tests/fixtures/my_fixture/
git commit -m "Add Calibre fixture: my_fixture"
```

### Using Fixtures in Tests

```rust
#[test]
fn test_my_operation() {
    // Load fixture (automatically copied to temp dir)
    let (_temp, mut client) = setup_empty_library();

    // Perform operation via libcalibre
    client.add_book(standard_test_book()).unwrap();

    // Capture and compare to snapshot
    let snapshot = DatabaseSnapshot::capture(&client.get_database_path())
        .unwrap()
        .normalize();

    assert_yaml_snapshot!(snapshot);
}
```

## Writing Tests

### Basic Test Pattern

```rust
mod common;

use common::{setup_empty_library, standard_test_book, DatabaseSnapshot};
use insta::assert_yaml_snapshot;

#[test]
fn test_operation_name() {
    // 1. Setup
    let (_temp, mut client) = setup_empty_library();

    // 2. Perform operation
    client.some_operation().unwrap();

    // 3. Capture and snapshot
    let snapshot = DatabaseSnapshot::capture(&client.get_database_path())
        .expect("Failed to capture")
        .normalize();

    assert_yaml_snapshot!(snapshot);
}
```

### Test Naming Convention

Use descriptive names that indicate what behavior is being tested:

- `test_add_single_book_full_database` - Adding one book captures entire DB state
- `test_add_book_with_multiple_authors` - Specific edge case
- `test_update_book_metadata` - Update operation

### What to Test

Focus on operations that modify the database:

- ✅ Adding books
- ✅ Updating books
- ✅ Creating authors
- ✅ Linking authors to books
- ✅ Adding identifiers
- ✅ Setting descriptions
- ✅ Updating read state
- ❌ Read-only operations (no need to snapshot)

## Comparing to Calibre Behavior

### Golden Master Testing (Optional)

To verify libcalibre matches Calibre exactly:

```bash
# 1. Create identical starting points
cp tests/fixtures/empty_library/metadata.db calibre_test.db
cp tests/fixtures/empty_library/metadata.db libcalibre_test.db

# 2. Perform same operation via Calibre
calibredb add book.epub --library-path=./calibre_test.db

# 3. Perform same operation via libcalibre (in test)
# ... test code ...

# 4. Capture both snapshots and compare
# This is done in the test itself
```

## Troubleshooting

### Test fails due to timestamp/UUID differences

Make sure you're calling `.normalize()` on the snapshot:

```rust
let snapshot = DatabaseSnapshot::capture(&db_path)
    .unwrap()
    .normalize();  // <-- Don't forget this!
```

### Snapshot contains unexpected data

This is a **feature**! It means libcalibre is doing something different from what you expected. Investigate:

1. Is this an unimplemented Calibre feature?
2. Is this a bug in libcalibre?
3. Is this expected but undocumented behavior?

### Test is slow

Database snapshot tests are fast (<100ms each), but if you have many:

- Use `cargo test -- --test-threads=1` to run serially
- Consider grouping related operations into one test
- Check if fixture copying is slow (use smaller fixtures)

## Maintenance

### Updating Snapshots When Behavior Changes

When you **intentionally** change libcalibre's behavior:

```bash
# 1. Run tests (they will fail)
cargo test

# 2. Review changes
cargo insta review

# 3. Accept new snapshots if correct
# Press 'a' for each snapshot

# 4. Commit updated snapshots
git add tests/snapshots/
git commit -m "Update snapshots for new behavior"
```

### Upgrading Calibre Version

If you upgrade the Calibre fixtures (e.g., to Calibre 7.3):

```bash
# 1. Generate new fixtures with Calibre 7.3
calibredb add_empty_library ./new_fixture

# 2. Replace old fixtures
rm -rf tests/fixtures/empty_library/*
cp ./new_fixture/* tests/fixtures/empty_library/

# 3. Regenerate all snapshots
cargo test
cargo insta review --accept

# 4. Commit everything
git add tests/fixtures/ tests/snapshots/
git commit -m "Upgrade to Calibre 7.3 fixtures"
```

## Test Types

libcalibre uses multiple testing approaches for comprehensive coverage, in order
of preference for you to write them:

### 1. Doc Tests
- **What**: Examples in doc comments that run as tests
- **Coverage**: API documentation and simple usage examples
- **When to use**: Documenting public API with runnable examples

### 1. Unit Tests
- **What**: Direct function tests for business logic
- **Coverage**: Author/title sorting, name generation, sanitization
- **When to use**: Testing pure functions and transformations

### 1. Snapshot Tests
- **What**: Capture entire database state and compare to committed snapshots
- **Coverage**: Full integration paths for database operations
- **When to use**: Testing add/update/delete operations

### 1. Property-Based Tests
- **What**: Generate hundreds of random inputs to verify invariants
- **Coverage**: Filesystem safety, determinism, edge cases
- **When to use**: Verifying properties hold for ALL inputs

## Code Coverage

### Viewing Coverage Reports

Install `cargo-llvm-cov`:
```bash
cargo install cargo-llvm-cov
```

Generate coverage reports:
```bash
# HTML summary
cargo llvm-cov --package libcalibre --all-features --html
```
